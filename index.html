<!DOCTYPE html>
<html>
<head>
<title>Jira Ticket Generator</title>
<script type="text/javascript" src="TicketGenerator.js"></script>
<script type="text/javascript" src="App.js"></script>
</head>
<body>
	<div id="tickets"></div>
	<script>
	
		function getParameter(l_sName)
		{
			var l_oMatch = window.location.search.match(new RegExp("[?&]" + l_sName + "=([^&]*)"));
			return ((l_oMatch == null) ? null : l_oMatch[1]);
		};
		
		var project = getParameter("project");
		var fixversion = getParameter("fixversion");
		jiraId = getParameter("jira");
		var jiraUrl = "https://jira.caplin.com/rest/api/latest/search?jql=project=" + project + "%20AND%20fixversion=" + fixversion + "&fields=key&jsonp-callback=x&maxResults=1000";
		
		var scriptElement = document.createElement("script");
		scriptElement.setAttribute("type", "text/javascript");
		scriptElement.setAttribute("src", jiraUrl);
		document.head.appendChild(scriptElement);
		
		
		var oApp = new jira.App("tickets", fixversion);
		
		var cards = 0;
		var pageElement = document.createElement("div");
		function getJiraCallback(e) {
			
			if (cards%2 == 0) {
				pageElement = document.createElement("div");
				pageElement.style.pageBreakAfter = "always";
				pageElement.style.clear = "both";
				document.getElementById("tickets").appendChild(pageElement);
			}
			oApp.getJiraCallback(e, pageElement);
			cards++
		}
		
		function x(e) {
			if (jiraId != null && jiraId != undefined) {
				var jiraIds = jiraId.split(",");
				var jirasArray = [];
				for (var i=0; i < e.issues.length; i++) {
					console.log(jiraIds.indexOf(e.issues[i].key));
					
					if (jiraIds.indexOf(e.issues[i].key) !== -1) {
						jirasArray.push(e.issues[i]);
					}
				}
				console.log("|ZZZ", jirasArray);
				e.issues = jirasArray;
			}
			oApp.x(e);
		}
	</script>
	<script type="text/javascript"
		src=
></script>
</body>
</html>