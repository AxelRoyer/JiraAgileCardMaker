<!DOCTYPE html>
<html>
<head>
<title>Jira Ticket Generator</title>
<script type="text/javascript" src="TicketGenerator.js"></script>
<script type="text/javascript" src="App.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
	<div id="tickets"></div>
    <div>
        
    <div style="min-height:100%" id="ticketManager">
        <h1>Jira Ticket Generator</h1>
        <div id="optionsPanel">
            <ul>
                <li>Jira Location : <input id="jiraLocation" value="https://jira.caplin.com"></input></li>
                <li>Color Enabled: <input checked=true type="checkbox" id="color"></input></li>
                <li>QR Code Enabled: <input checked=true type="checkbox" id="qrcode"></input></li>
            </ul>
        </div>
        <div>
            <h2>Project</h2>
            <ul>
                <li>Wizard : <input id="wizard" value="https://jira.caplin.com/browse/PAPAMAFX/fixforversion/13153" style="width: 400px"></input><button onclick=wizard()>Generate</button></li>
                <li>Project Name : <input id="project"></input></li>
                <li>Fix Version : <input id="fixversion"></input></li>
            </ul>
            <button onclick="getJiras()">Fetch!</button>
        </div>
        <h1>Jira List</h1>
        <div id="jiraList">
            <ul id="jiraListUrl">
                
            </ul>
        </div>
        <button onClick="generateTickets()">Generate!</button>
    </div>
    </div>
	<script>
	
        function wizard() {
           var url = document.getElementById("wizard").value;
           projectStart = url.indexOf("browse/");
           fixversionStart = url.indexOf("fixforversion/");
           
           if (projectStart != -1 && fixversionStart != -1) {               
                project = url.substring(projectStart+7, fixversionStart-1);
                fixversion = url.substring(fixversionStart+14);
                document.getElementById("project").value = project;
                document.getElementById("fixversion").value = fixversion;
                document.getElementById("wizard").value = "";
                console.log(project, fixversion);
           } else {
               alert("This url was unrecognized");
               alert("try: \"https://jira.caplin.com/browse/PSL/fixforversion/12733\"")
           }
           
        }
		function getParameter(l_sName)
		{
			var l_oMatch = window.location.search.match(new RegExp("[?&]" + l_sName + "=([^&]*)"));
			return ((l_oMatch == null) ? null : l_oMatch[1]);
		};
		
        jiraId = getParameter("jira");
		
        function initializeFields() {
            var project = getParameter("project");
		    var fixversion = getParameter("fixversion");
            document.getElementById("project").value = project;
            document.getElementById("fixversion").value = fixversion;
        } 
        
        initializeFields();
        
        function getJiras() {
            console.log("Jiras Requested!");
            var project = document.getElementById("project").value
    	    var fixversion = document.getElementById("fixversion").value;
            
            
        	var jiraUrl = "https://jira.caplin.com/rest/api/latest/search?jql=project=" + project + "%20AND%20fixversion=" + fixversion + "&fields=key&jsonp-callback=x&maxResults=1000";
                
        	var scriptElement = document.createElement("script");
    		scriptElement.setAttribute("type", "text/javascript");
    		scriptElement.setAttribute("src", jiraUrl);
            document.head.appendChild(scriptElement);
        }
        
		//document.head.appendChild(scriptElement);
		
		var cards = 0;
		var pageElement = document.createElement("div");
		function getJiraCallback(e) {
			
			if (cards%2 == 0) {
				pageElement = document.createElement("div");
				pageElement.style.pageBreakAfter = "always";
				pageElement.style.clear = "both";
				document.getElementById("tickets").appendChild(pageElement);
			}
			oApp.getJiraCallback(e, pageElement);
			cards++
		}
        
        function addCheckList(name, callback, className) {
            var jiraList = document.getElementById("jiraListUrl");
            var li = document.createElement("li");
                
            var checkbox = document.createElement("input")
            checkbox.type = "checkbox";
            checkbox.className = className;
            checkbox.name = name;
            checkbox.checked = true;
            
            if (callback != null && callback != undefined) {
                checkbox.onclick = callback;
            }
            
            var label = document.createTextNode(name);
            
            li.appendChild(checkbox);
            li.appendChild(label);
            
            jiraList.appendChild(li);
        }
        
        function allJirasClicked() {
            var jiraChecklists = document.getElementsByClassName("jiracheck");
            for (var i=0; i < jiraChecklists.length; i++) {
                jiraChecklists[i].checked = this.checked;
            }   
        }
        
        function addJirasToInterface(issues) {            
            addCheckList("All", allJirasClicked, null);
            for (var i=0; i < issues.length; i++) {
                var issue = issues[i];
                addCheckList(issue.key, null, "jiracheck");
            }
        }
        
        function x(e) {
            addJirasToInterface(e.issues);
        }
        
        function generateTickets() {
            var jiraChecklists = document.getElementsByClassName("jiracheck");
            var checklistToDisplay = [];
            for (var i=0; i < jiraChecklists.length; i++) {
                var jiraCheck = jiraChecklists[i];
                if (jiraCheck.checked) {
                    checklistToDisplay.push(jiraCheck.name);
                }
            }   
            var interface = document.getElementById("ticketManager");
            interface.style.display = "none";
            console.log(checklistToDisplay);
            var color = document.getElementById("color").checked;
            var qrcode = document.getElementById("qrcode").checked;
            oApp = new jira.App("tickets", document.getElementById("fixversion").value, color, qrcode);
            doSomething(checklistToDisplay);
            
        }
		
		function doSomething(jiras) {
			oApp.x(jiras);
		}
	</script>
	<script type="text/javascript"
		src=
></script>
</body>
</html>